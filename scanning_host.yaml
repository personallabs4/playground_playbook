---
- name: OpenSCAP Security Compliance Scan
  hosts: all
  become: yes
  vars:
    scap_reports_dir: "/opt/reports"
    scap_profiles_src: "/opt/scap_profiles"  # Source directory on control node
    scap_guide_version: "0.1.76"
    timezone_offset: "+07:00"
    report_server: "http://10.20.11.117:2112"
    
  tasks:
    # Task 1: Check OS and mark host
    - name: Gather mandatory OS facts
      ansible.builtin.setup:
        gather_subset: min
        filter: "ansible_distribution*"
      register: os_facts
      ignore_errors: yes
      tags: always

    - name: Set safe OS facts
      ansible.builtin.set_fact:
        distro_name: "{{ (os_facts.ansible_facts.ansible_distribution | default('unknown')) | lower }}"
        distro_version: "{{ os_facts.ansible_facts.ansible_distribution_major_version | default('0') }}"
      tags: always

    # Task 2: Profile handling with bulletproof validation
    - name: Create SCAP directory structure
      ansible.builtin.file:
        path: "/opt/scap_profiles"
        state: directory
        mode: '0755'
      tags: scan

    - name: Generate target profile pattern
      ansible.builtin.set_fact:
        target_profile_pattern: "ssg-{{ distro_name }}{{ distro_version }}-ds.xml"
      tags: scan

    - name: Find matching profiles on target
      ansible.builtin.find:
        paths: "/opt/scap_profiles"
        patterns: "{{ target_profile_pattern }}"
        use_regex: no
      register: target_profiles
      tags: scan

    - name: Validate exactly one profile found
      ansible.builtin.assert:
        that:
          - target_profiles.matched == 1
        fail_msg: >-
          Found {{ target_profiles.matched }} profiles matching {{ target_profile_pattern }}.
          Expected exactly 1.
      tags: scan

    - name: Set exact profile path
      ansible.builtin.set_fact:
        scap_profile_path: "{{ target_profiles.files[0].path }}"
      when: target_profiles.matched == 1
      tags: scan

    # Task 3: Run OpenSCAP evaluation (updated to use validated path)
    - name: Execute OpenSCAP scan
      ansible.builtin.command: >
        oscap xccdf eval
        --profile xccdf_org.ssgproject.content_profile_cis_level2_server
        --results-arf "{{ scap_reports_dir }}/{{ ansible_date_time.iso8601_basic_short }}-arf.xml"
        "{{ scap_profile_path }}"
      when: scap_profile_path is defined
      register: oscap_scan
      changed_when: "'Rule: Some rules failed.' in oscap_scan.stdout"
      failed_when: 
        - oscap_scan.rc != 0
        - "'Rule: Some rules failed.' not in oscap_scan.stdout"
      tags: scan

    # Task 4: Fix timestamp in ARF report
    - name: Adjust timezone in ARF report
      ansible.builtin.shell: >
        sed -i -E 's/([0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2})([^:+Z0-9]|")/\1{{ timezone_offset }}\2/g'
        "{{ scap_reports_dir }}/{{ ansible_date_time.iso8601_basic_short }}-arf.xml"
      args:
        executable: /bin/bash
      when: oscap_scan is changed or oscap_scan is success
      tags: post_scan

    # Task 5: Upload report to server
    - name: Upload compliance report
      ansible.builtin.uri:
        url: "{{ report_server }}/upload"
        method: POST
        body_format: form-multipart
        headers:
          Content-Type: "multipart/form-data"
        body:
          target: "{{ inventory_hostname }}"
          report: "@{{ scap_reports_dir }}/{{ ansible_date_time.iso8601_basic_short }}-arf.xml"
      register: upload_result
      when: oscap_scan is changed or oscap_scan is success
      tags: post_scan

    # Task 6: Trigger report rendering
    - name: Trigger report generation
      ansible.builtin.uri:
        url: "{{ report_server }}/render"
        method: GET
      register: render_result
      when: upload_result is defined and upload_result.status == 200
      tags: post_scan

  handlers:
    - name: Clean up on failure
      ansible.builtin.file:
        path: "{{ scap_reports_dir }}"
        state: absent
      when: "'oscap_scan' in vars and oscap_scan is failed"
      tags: cleanup
